{% extends 'base.html' %}
{% block title %}Enroll | University Face Attendance{% endblock %}
{% block content %}
    <div class="card">
        <h1>Enroll New Person</h1>
        <p style="color:#4b5563; margin-top:-6px;">Provide your ID and capture a clear face image.</p>
        <div style="margin: 12px 0; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;">
            <label for="name" style="display:none">Name</label>
            <input id="name" type="text" placeholder="Enter your ID" style="padding:8px;width:220px;" autofocus />
            <label for="role" style="display:none">Role</label>
            <select id="role" style="padding:8px;">
                <option value="student">Student</option>
                <option value="teacher">Teacher</option>
            </select>
            <label for="password" style="display:none">Password</label>
            <input id="password" type="password" placeholder="Set password" style="padding:8px;width:220px;" />
        </div>
        <video id="video" autoplay playsinline width="480" height="360" style="border-radius:12px;background:#000; box-shadow: 0 8px 30px rgba(17,24,39,.2)"></video>
        <div>
            <button id="capture" class="btn">Capture & Enroll</button>
            <a href="{{ url_for('index') }}" class="btn" style="background:#6c757d">Home</a>
        </div>
        <p id="status"></p>
    </div>
    <canvas id="canvas" width="480" height="360" style="display:none"></canvas>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusEl = document.getElementById('status');
        const nameInput = document.getElementById('name');
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (e) {
                statusEl.textContent = 'Camera access denied: ' + e.message;
            }
        }
        function captureImage() {
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/png');
        }
        const captureBtn = document.getElementById('capture');
        captureBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (!name) { statusEl.textContent = 'Please enter your ID.'; return; }
            const dataUrl = captureImage();
            statusEl.textContent = 'Submitting...';
            captureBtn.disabled = true;
            try {
                const res = await fetch("{{ url_for('api_enroll') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, role: document.getElementById('role').value, password: document.getElementById('password').value, image: dataUrl })
                });
                const json = await res.json().catch(() => ({ ok:false, error:'Invalid server response' }));
                if (json.ok) {
                    statusEl.textContent = 'Successfully enrolled ID: ' + name + '. Redirecting to home...';
                    if (window.showToast) showToast('Enrolled successfully', 'success');
                    setTimeout(() => { window.location.href = "{{ url_for('index') }}"; }, 1000);
                } else {
                    statusEl.textContent = 'Failed: ' + (json.error || 'Unknown error');
                }
            } catch (e) {
                statusEl.textContent = 'Error: ' + e.message;
            } finally { captureBtn.disabled = false; }
        });
        init();
    </script>
{% endblock %}